<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>安徽食品安全培训网</title>
	<link href="img/logo.png" rel="SHORTCUT ICON">
	<link rel="stylesheet" href="css/nprogress.css">
	<script type="text/javascript" src="js/nprogress.js"> </script>
	<link rel="stylesheet" href="layui/css/layui.css" />
	<link rel="stylesheet" href="css/swiper.min.css">
	<link rel="stylesheet" href="css/index.css" />
	<style>
		.examination .right form .layui-form-checkbox,
		.layui-form-select dl dd.layui-disabled {
			margin-bottom: 20px !important;
		}
	</style>
</head>

<body>
	<!-- 头部 -->
	<header>
		<div class="top">
			<section>
				<p>你好，欢迎访问滁州食品安全网</p>
				<p>
					<a onclick="openUrl('login.html')" href="javascript:;">现在登录！</a>
				</p>
				<p><img src="img/user.png" />个人中心</p>
			</section>
			<nav>
				<h1 onclick="openUrl('index.html')">
					<img src="img/logo.png" />
					<p>安徽食品安全培训网</p>
					<i>Food safety training in anhui province </i>
				</h1>
				<ul id="navList">
					<li>首页<i></i></li>
					<li>课程中心<i></i></li>
					<li>学习指南<i></i></li>
					<li>教学公告<i></i></li>
					<li>食品安全资讯<i></i></li>
					<li>在线证书查询<i></i></li>
					<li>考试中心<i></i></li>
				</ul>
			</nav>
		</div>
	</header>
	<div class="">
		<!-- 子页面轮播 -->
		<div class="swiper-container sonBanner">
			<div class="swiper-wrapper">
				<div class="swiper-slide">
					<img src="img/sbanner.png" />
				</div>
				<div class="swiper-slide">
					<img src="img/sbanner.png" />
				</div>
			</div>
		</div>
		<section class="centre">
			<h1 class="titleSon">
				<a href="index.html">首页</a>
				<a href="testCenter.html">> 考试中心</a>
				<a href="">> <span class="examName">加载中</span></a>
			</h1>
			<div class="examination">
				<div class="left fixation">
					<ul id="sequence">
						<li>
							<h1>单选题</h1>
							<div id="numChoiceListHtml">
								<!-- <span class="number">1</span> -->
							</div>
						</li>
						<li>
							<h1>判断题</h1>
							<div id="numjudgeListHtml">
								<!-- <span class="number">5</span> -->
							</div>
						</li>
						<li>
							<h1>多选题</h1>
							<div id="nummultiChoiceListHtml">
								<!-- <span class="number">8</span> -->
							</div>
						</li>
					</ul>
					<button type="button" class="layui-btn submit">确认交卷</button>
				</div>
				<div class="right">
					<h1 class="examName"></h1>
					<p>
						<span><i class="layui-icon layui-icon-log"></i>限时<em class="limitedTime"></em>分钟</span>
						<span><i class="layui-icon layui-icon-form"></i>共<em class="questionNum"></em>题</span>
						<span class="nowTime"></span>
						<b><time>考试开始！</time></b>
					</p>
					<form class="layui-form" action="">
						<ul id="topic">
							<div id="ChoiceListHtml"></div>
							<div id="judgeListHtml"></div>
							<div id="multiChoiceListHtml"></div>
						</ul>
					</form>
				</div>
				<div class="clear"></div>
			</div>
			<!-- 考试结果 -->
			<div class="certificate" style="display: none;">
				<form class="layui-form" action="">
					<h1>考试成绩</h1>
					<span></span>
					<div class="examResult">
						<div class="circle">
							<p><em class="font"></em><i>分</i></p>
							<div class="white">
								考试结束
							</div>
						</div>
						<b class="pass"></b>
						<button onclick="openUrl('certificate.html')" type="button"
							class="layui-btn query">在线查询资格证书</button>
					</div>
				</form>
			</div>
		</section>
	</div>
	<footer></footer>
	<input type="hidden" id="timeCost" value="" />
	<input type="hidden" id="id" value="" />
	<script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
	<script type="text/javascript" src="layui/layui.all.js"></script>
	<script type="text/javascript" src="js/swiper.min.js"> </script>
	<script type="text/javascript" src="js/numscroll.js"></script>
	<script type="text/javascript" src="js/main.js"></script>
	<script>
		//轮播图
		var indexBannerswiper = new Swiper('.sonBanner', {
			autoplay: {
				delay: 5000
			},
		});

		//考试试题列表
		exam();
		function exam() {
			http.ajax({
				url: 'exam/exam',
				type: 'GET',
				json: false,
				mask: true,
				data: {
					examCenterId: getQueryString("id")
				}
			}).then(function (data) {
				var result = data.data;
				var numChoiceListHtml = '';
				var numjudgeListHtml = '';
				var nummultiChoiceListHtml = '';
				var ChoiceListHtml = '';
				var judgeListHtml = '';
				var multiChoiceListHtml = '';
				if (data.code == 200) {
					// 总题数量
					var total = result.choiceList.length + result.judgeList.length + result.multiChoiceList.length;
					// 简介
					$(".examName").text(result.info.examName);
					$(".questionNum").text(total);
					$(".limitedTime").text(result.info.limitedTime);
					$("#id").val(result.id);
					$(".nowTime").html(getNowFormatDate()+" 开考")
					//单选题序号循环
					for (var i = 0; i < result.choiceList.length; i++) {
						numChoiceListHtml += '<span class="number">' + (i + 1) + '</span>';
					};
					$("#numChoiceListHtml").append(numChoiceListHtml);
					//判断题序号循环
					for (var i = 0; i < result.judgeList.length; i++) {
						numjudgeListHtml += '<span class="number">' + (result.choiceList.length + i + 1) + '</span>';
					};
					$("#numjudgeListHtml").append(numjudgeListHtml);
					//多选题序号循环
					for (var i = 0; i < result.multiChoiceList.length; i++) {
						nummultiChoiceListHtml += '<span class="number">' + (result.choiceList.length + result.choiceList.length + i + 1) + '</span>';
					};
					$("#nummultiChoiceListHtml").append(nummultiChoiceListHtml);

					// 单选题题目渲染
					for (var i = 0; i < result.choiceList.length; i++) {
						ChoiceListHtml += "<li id=" + result.choiceList[i].id + "><p>" +
							"<span style='margin-right: 0px;'>" + (i + 1) + "</span>、" + result.choiceList[i].name + "" +
							"</p>" +
							"<div class=\"layui-input-block\">";
						for (var j = 0; j < result.choiceList[i].chooseResultList.length; j++) {
							ChoiceListHtml += "<input type=\"radio\" name=\"dx" + i + "\" value=\"" + j + "\" title=\"" + indexToString(j) + "：" + result.choiceList[i].chooseResultList[j].choose + "\">";
						}
						ChoiceListHtml += "</div>" +
							"<em class=\"layui-icon layui-icon-rate-solid\"></em>" +
							"</li>";
					}
					$("#ChoiceListHtml").append(ChoiceListHtml);

					// 判断题题目渲染
					for (var i = 0; i < result.judgeList.length; i++) {
						judgeListHtml += "<li id=" + result.judgeList[i].id + "><p>" +
							"<span style='margin-right: 0px;'>" + (result.choiceList.length + i + 1) + "</span>、" + result.judgeList[i].name + "" +
							"</p>" +
							"<div class=\"layui-input-block\">";
						for (var j = 0; j < result.judgeList[i].chooseResultList.length; j++) {
							judgeListHtml += "<input type=\"radio\" name=\"pd" + i + "\" value=\"" + j + "\" title=\"" + indexToString(j) + "：" + result.judgeList[i].chooseResultList[j].choose + "\">";
						}
						judgeListHtml += "</div>" +
							"<em class=\"layui-icon layui-icon-rate-solid\"></em>" +
							"</li>";
					}
					$("#judgeListHtml").append(judgeListHtml);

					// 多选题题目渲染
					for (var i = 0; i < result.multiChoiceList.length; i++) {
						multiChoiceListHtml += "<li id=" + result.multiChoiceList[i].id + "><p>" +
							"<span style='margin-right: 0px;'>" + (result.choiceList.length + result.choiceList.length + i + 1) + "</span>、" + result.multiChoiceList[i].name + "" +
							"</p>" +
							"<div class=\"layui-input-block multipleChoice\">";
						for (var j = 0; j < result.multiChoiceList[i].chooseResultList.length; j++) {
							multiChoiceListHtml += "<input type=\"checkbox\" name=\"dx" + i + "\" value=\"" + j + "\" title=\"" + indexToString(j) + "：" + result.multiChoiceList[i].chooseResultList[j].choose + "\">";
						}
						multiChoiceListHtml += "</div>" +
							"<em class=\"layui-icon layui-icon-rate-solid\"></em>" +
							"</li>";
					}
					$("#multiChoiceListHtml").append(multiChoiceListHtml);

					// 数据绑定到右侧答题卡
					$("#topic  li .layui-input-block").click(function () {
						var selectedIndex = $(this).parents("li").find("p span").text()-1;
						$("#sequence .number").eq(selectedIndex).addClass("green");
						if ($(this).hasClass("multipleChoice")) {
							if ($(this).find('.layui-form-checked').length == 0) {
								$("#sequence .number").eq(selectedIndex).removeClass("green");
							}
						}
					});
					//收藏题目
					$("#topic li em").click(function () {
						var selectedIndex = $(this).parents("li").find("p span").text()-1;
						if ($(this).hasClass("activeStar")) {
							$(this).removeClass("activeStar");
							$("#sequence .number").eq(selectedIndex).removeClass("yellow")
						} else {
							$(this).addClass("activeStar");
							$("#sequence .number").eq(selectedIndex).addClass("yellow")
						}
					})
					
					renderForm();
					//倒计时,时间存入缓存，休想刷新混时长
					var maxtime = result.info.limitedTime * 60;
					console.log(localStorage.getItem("maxtime"))
					if (localStorage.getItem("maxtime")) {
						maxtime = localStorage.getItem("maxtime");
						timer = setInterval(function () {
							if (maxtime >= 0) {
								$("#timeCost").val($(".limitedTime").text() * 60 - maxtime);
								minutes = Math.floor(maxtime / 60);
								seconds = Math.floor(maxtime % 60);
								msg = "剩余时间：" + minutes + "分" + seconds + "秒";
								localStorage.setItem("maxtime", maxtime);
								$("time").text(msg);
								if (maxtime == 5 * 60) layer.msg('考试结束还剩5分钟!', { icon: 1 });
								--maxtime;
							} else {
								clearInterval(timer);
								$("time").text('考试结束!')
								layer.msg('时间到，考试结束!', {
									icon: 1
								});
								//时间到，直接提交
								examSubmit();
								localStorage.removeItem("maxtime");
							}
						}, 1000);
						window.addEventListener("beforeunload", function (e) {
							var confirmationMessage = "\o/";
							(e || window.event).returnValue = confirmationMessage; // Gecko and Trident
							return confirmationMessage; // Gecko and WebKit
						});
					} else {
						layer.confirm('考试马上开始，准备好了吗？', {
							btn: ['是', '否'],
							title: "温馨提示",
							closeBtn: 0
						}, function () {
							layer.msg('考试开始！', { icon: 1 });
							timer = setInterval(function () {
								if (maxtime >= 0) {
									$("#timeCost").val($(".limitedTime").text() * 60 - maxtime);
									minutes = Math.floor(maxtime / 60);
									seconds = Math.floor(maxtime % 60);
									msg = "剩余时间：" + minutes + "分" + seconds + "秒";
									localStorage.setItem("maxtime", maxtime);
									$("time").text(msg);
									if (maxtime == 5 * 60) layer.msg('考试结束还剩5分钟!', { icon: 1 });
									--maxtime;
								} else {
									clearInterval(timer);
									$("time").text('考试结束!')
									layer.msg('时间到，考试结束!', {
										icon: 1
									});
									//时间到，直接提交
									examSubmit();
									localStorage.removeItem("maxtime");
								}
							}, 1000);
						}, function () {
							history.back();
						});
					}
				}
			}, function (err) {
				if (err.status == 403) {
					layer.msg('未登录，不可操作！', {
						icon: 5,
						time: 800,
					}, function () {
						location.href = 'login.html';
					});
				}
			})
		}
		//提交
		$(".submit").click(function () {
			layer.confirm('确定提交答卷？', {
				title: "温馨提示",
				btn: ['确定', '再看看'] //按钮
			}, function () {
				examSubmit();
			}, function () {

			});
		});

		function examSubmit() {
			var dataList = ''
			var choiceAnswer = [];
			var judgeAnswer = [];
			var multiChoiceAnswer = [];

			for (var i = 0; i < $("#ChoiceListHtml li").length; i++) {
				// 单选框的值
				var answerList = $("#ChoiceListHtml li").eq(i).find("input:checked").val() * 1;
				if (answerList == undefined) {
					answerList = ""
				}
				choiceAnswer.push({
					"answerList": [answerList],
					"testQuestionId": $("#ChoiceListHtml li").eq(i).attr("id")
				});
			};
			for (var i = 0; i < $("#judgeListHtml li").length; i++) {
				// 判断框的值
				var answerList = $("#judgeListHtml li").eq(i).find("input:checked").val() * 1;
				if (answerList == undefined) {
					answerList = ""
				}
				judgeAnswer.push({
					"answerList": [answerList],
					"testQuestionId": $("#judgeListHtml li").eq(i).attr("id")
				});
			};
			for (var i = 0; i < $("#multiChoiceListHtml li").length; i++) {
				// 多选框的值
				var answerList = [];
				for (var j = 0; j < $("#multiChoiceListHtml li").eq(i).find("input:checked").length; j++) {
					answerList.push($("#multiChoiceListHtml li").eq(i).find("input:checked").eq(j).val() * 1)
				}
				multiChoiceAnswer.push({
					"answerList": answerList,
					"testQuestionId": $("#multiChoiceListHtml li").eq(i).attr("id")
				});
			};

			dataList = {
				choiceAnswer: choiceAnswer,
				judgeAnswer: judgeAnswer,
				multiChoiceAnswer: multiChoiceAnswer,
				testPaperId: $("#id").val(),
				timeConsum: $("#timeCost").val(),//用了多长时间交卷
				type: 'exam'//exam(考试)exercise(练习)
			};

			http.ajax({
				url: 'exam/submit',
				type: 'POST',
				json: true,
				mask: true,
				data: JSON.stringify(dataList)
			}).then(function (data) {
				var result = data;
				if (data.code == 200) {
					layer.msg('考试结果正在加载中', { icon: 16, time: '950' })
					setTimeout(function () {
						$(".examination").hide();
						$(".certificate").show();
						//初始化数字滚动特效
						$(".font").text(result.data.score);
						if(result.data.pass == true){
							$(".pass").html("恭喜您已成功通过<br> 【"+result.data.info.examName+"】考试")
						}else{
							$(".pass").html("很抱歉考试未合格，请重新参加<br> 【"+result.data.info.examName+"】考试")
							$(".examResult .circle").css("border","7px solid #9A979A");
							$(".examResult .circle p").css("color","#9A979A");
							$(".examResult .circle p i").css("color","#9A979A");
						}
						$(".font").numScroll();
					}, 1000)
				}
			}, function (err) {

			})
		}


		// 鼠标下滑，左侧答题卡固定在顶部
		var ie6 = /msie 6/i.test(navigator.userAgent);
		var tableDv = $('.fixation');
		var st;
		tableDv.attr('otop', tableDv.offset().top); //存储原来的距离顶部的距离
		$(window).scroll(function () {
			st = Math.max(document.body.scrollTop || document.documentElement.scrollTop);
			if (st >= parseInt(tableDv.attr('otop'))) {
				if (ie6) {//IE6不支持fixed属性，所以只能靠设置position为absolute和top实现此效果
					tableDv.css({ position: 'absolute', top: st });
				} else if (tableDv.css('position') != 'fixed') {
					tableDv.css({ 'position': 'fixed', top: 0 });
				}
				console.log(1)
				$(".examination .right").css("margin-left", "272px")
			} else if (tableDv.css('position') != 'static') {
				tableDv.css({ 'position': 'static' });
				console.log(2)
				$(".examination .right").css("margin-left", "62px")
			}

		});



	</script>
</body>

</html>